<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Loader Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: white;
            font-family: monospace;
        }
        #container {
            width: 100%;
            height: 400px;
            background: #000;
            margin-top: 20px;
        }
        .log {
            background: #2a2a2a;
            padding: 10px;
            margin: 5px 0;
            border-left: 3px solid #4CAF50;
        }
        .error {
            border-left-color: #f44336;
        }
        .info {
            border-left-color: #2196F3;
        }
    </style>
</head>
<body>
    <h1>3D Model Loader Test</h1>
    <div id="status">Checking loaders...</div>
    <div id="logs"></div>
    <div id="container"></div>

    <!-- Import Map for Three.js modules -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.180.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.180.0/examples/jsm/"
        }
    }
    </script>
    
    <!-- Initialize THREE globally -->
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        
        // Make THREE available globally
        window.THREE = THREE;
        
        // Make GLTFLoader available globally (separate from THREE)
        window.GLTFLoader = GLTFLoader;
        
        console.log('THREE loaded!');
        console.log('GLTFLoader available:', typeof GLTFLoader);
        window.dispatchEvent(new Event('three-ready'));
    </script>

    <script>
        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');
        
        function log(message, type = 'log') {
            console.log(message);
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = message;
            logsDiv.appendChild(div);
        }

        async function testLoaders() {
            // Check if Three.js is loaded
            if (typeof THREE === 'undefined') {
                log('ERROR: Three.js not loaded!', 'error');
                statusDiv.textContent = 'FAILED: Three.js not loaded';
                return;
            }
            log('Three.js loaded successfully', 'info');

            // Check if GLTFLoader is available
            if (typeof GLTFLoader === 'undefined') {
                log('ERROR: GLTFLoader not available!', 'error');
                statusDiv.textContent = 'FAILED: GLTFLoader not available';
                return;
            }
            log('GLTFLoader available', 'info');

            // Setup scene
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x222222);
            
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / 400, 0.1, 1000);
            camera.position.z = 5;
            
            const renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth - 40, 400);
            document.getElementById('container').appendChild(renderer.domElement);
            
            // Add lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            log('Scene setup complete', 'info');

            // Try to load the GLB model
            const loader = new GLTFLoader();
            log('Attempting to load: assets/models/base_ship.glb', 'info');
            
            try {
                loader.load(
                    'assets/models/base_ship.glb',
                    (gltf) => {
                        log('SUCCESS: Model loaded!', 'info');
                        statusDiv.textContent = 'SUCCESS: Model loaded successfully!';
                        
                        const model = gltf.scene;
                        scene.add(model);
                        
                        // Center and scale the model
                        const box = new THREE.Box3().setFromObject(model);
                        const center = box.getCenter(new THREE.Vector3());
                        model.position.sub(center);
                        
                        const size = box.getSize(new THREE.Vector3());
                        const maxDim = Math.max(size.x, size.y, size.z);
                        const scale = 3 / maxDim;
                        model.scale.setScalar(scale);
                        
                        log(`Model info: ${gltf.scene.children.length} children`, 'info');
                        
                        // Animate
                        function animate() {
                            requestAnimationFrame(animate);
                            model.rotation.y += 0.01;
                            renderer.render(scene, camera);
                        }
                        animate();
                    },
                    (progress) => {
                        if (progress.total > 0) {
                            const percent = (progress.loaded / progress.total * 100).toFixed(1);
                            log(`Loading: ${percent}%`, 'info');
                        }
                    },
                    (error) => {
                        log(`ERROR loading model: ${error.message}`, 'error');
                        statusDiv.textContent = 'FAILED: Could not load model';
                        
                        // Create fallback cube
                        const geometry = new THREE.BoxGeometry();
                        const material = new THREE.MeshPhongMaterial({ color: 0x00ff00 });
                        const cube = new THREE.Mesh(geometry, material);
                        scene.add(cube);
                        
                        function animate() {
                            requestAnimationFrame(animate);
                            cube.rotation.x += 0.01;
                            cube.rotation.y += 0.01;
                            renderer.render(scene, camera);
                        }
                        animate();
                    }
                );
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
                statusDiv.textContent = 'FAILED: Exception occurred';
            }
        }

        // Wait for THREE to be ready
        window.addEventListener('three-ready', () => {
            setTimeout(testLoaders, 100);
        });
    </script>
</body>
</html>

